<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="dashboard.css"/>
  <title>Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Dela+Gothic+One&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Delius&display=swap');

    body {
      background-color: #F6F5F0;
      font-family: "inter", sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    .header-container {
      text-align: left;
      padding: 10px;
    }

    .icon {
      font-family: "Dela Gothic One", sans-serif;
      font-size: 20px;
      color: #CC6D2E;
    }

    .editbtn, .deletebtn {
      padding: 8px 12px;
      font-size: 14px;
      margin: 0 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: white;
    }

    .editbtn { background-color: #007bff; }
    .deletebtn { background-color: #dc3545; }

    #popup, #retrievePopup, #editPopup {
      position: fixed;
      background: rgba(255, 255, 255, 0.811);
      top: 55%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      border: 2px solid #000;
      border-radius: 10px;
      z-index: 10;
      display: none;
    }

    .btnclose, .btnadd {
      margin: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .btnclose { background-color: gray; color: white; }
    .btnadd { background-color: green; color: white; }

    .active { display: block !important; }

    .pagination-controls {
      margin-top: 20px;
    }

    .pagination-controls button {
      padding: 8px 12px;
      margin: 0 5px;
      font-size: 14px;
      cursor: pointer;
    }

    th { cursor: pointer; }

    .search-input {
      width: 90%;
      height: 30px; /* ðŸ‘ˆ Increased from default */
      padding: 14px; /* ðŸ‘ˆ Add more padding for better visuals */
      font-size: 18px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    .input-field {
      color: #000;
      display: block;
      margin: 8px auto;
      padding: 6px;
      width: 90%;
    }
  </style>
</head>
<body>

  <div class="logout-container">
  <button onclick="logout()">Logout</button>
</div>



  <div class="header-container">
    <h1 class="icon">CRUDFlix</h1>
  </div>

  <div class="container">
    <h1 class="dashboard-title">Dashboard</h1>
    <p class="dashboard-description">Welcome to your dashboard! Here you can manage your movies, view ratings, and more.</p>
  </div>

  <div class="search-box">
  <input type="text" id="search" placeholder="Search keywords..." class="search-input">

  <div class="button-row">
    <button class="btnadd" onclick="addtoggle()">Add</button>
    <button class="btnadd" onclick="toggleRetrievePopup()">Retrieve</button>
  </div>
  </div>


  <div class="table-container">
    <h2>Movie List</h2>
    <table id="moviesTable" border="1" cellspacing="0" cellpadding="5" style="margin: auto;">
      <thead>
        <tr>
          <th onclick="sortTable('movieID')">Movie ID</th>
          <th onclick="sortTable('title')">Title</th>
          <th onclick="sortTable('director')">Director</th>
          <th onclick="sortTable('release_year')">Release Year</th>
          <th onclick="sortTable('rating')">Rating</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pagination-controls">
      <button onclick="changePage('prev')">Previous</button>
      <span id="pageIndicator">Page 1</span>
      <button onclick="changePage('next')">Next</button>
    </div>
  </div>

  <!-- ADD MOVIE POPUP -->
  <div id="popup">
    <h2>Add Movie</h2>
    <input type="text" id="title" placeholder="Title" class="input-field">
    <input type="text" id="director" placeholder="Director" class="input-field">
    <input type="number" id="release_year" placeholder="Release Year" class="input-field">
    <input type="number" id="rating" placeholder="Rating (0-10)" step="0.1" class="input-field">
    <button onclick="addtoggle2();" class="btnclose">Close</button>
    <button onclick="createMovies();" class="btnadd">Add</button>
  </div>

  <!-- RETRIEVE MOVIE POPUP -->
  <div id="retrievePopup">
    <h2>Retrieve Movie</h2>
    <input type="number" id="retrieve_movieID" placeholder="Movie ID" class="input-field">
    <input type="text" id="retrieve_title" class="input-field" disabled>
    <input type="text" id="retrieve_director" class="input-field" disabled>
    <input type="text" id="retrieve_release_year" class="input-field" disabled>
    <input type="text" id="retrieve_rating" class="input-field" disabled>
    <button onclick="toggleRetrievePopup();" class="btnclose">Close</button>
    <button onclick="retrieveMovieByID();" class="btnadd">Retrieve</button>
  </div>

  <!-- EDIT MOVIE POPUP -->
  <div id="editPopup">
    <h2>Edit Movie</h2>
    <input type="hidden" id="edit_movieID">
    <input type="text" id="edit_title" class="input-field">
    <input type="text" id="edit_director" class="input-field">
    <input type="number" id="edit_release_year" class="input-field">
    <input type="number" id="edit_rating" step="0.1" class="input-field">
    <button onclick="toggleEditPopup();" class="btnclose">Close</button>
    <button onclick="updateMovie();" class="btnadd">Update</button>
  </div>

  <script>
    // Prevent access if not logged in
    if (!localStorage.getItem("isLoggedIn")) {
      alert("Please log in first.");
      window.location.href = "http://127.0.0.1:5500/movies.html"; // or your login page path
    }

    function logout() {
      localStorage.removeItem("isLoggedIn");
      alert("Logged out successfully!");
      window.location.href = "http://127.0.0.1:5500/movies.html"; // or your login page path
    }

    let currentPage = 1;
    let sortBy = 'movieID';
    let order = 'asc';

    function addtoggle() {
      document.getElementById('popup').classList.add('active');
    }

    function addtoggle2() {
      document.getElementById('popup').classList.remove('active');
    }

    function toggleRetrievePopup() {
      document.getElementById("retrievePopup").classList.toggle("active");
    }

    function toggleEditPopup() {
      document.getElementById("editPopup").classList.toggle("active");
    }

    function createMovies() {
      const title = document.getElementById("title").value;
      const director = document.getElementById("director").value;
      const release_year = parseInt(document.getElementById("release_year").value);
      const rating = parseFloat(document.getElementById("rating").value);

      if (!title || !director || isNaN(release_year) || isNaN(rating)) {
        return alert("Please fill in all fields correctly.");
      }

      const Movies = { title, director, release_year, rating };

      fetch("http://127.0.0.1:3000/addmovies", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(Movies),
      })
      .then(res => res.json())
      .then(() => {
        alert("Movie added successfully!");
        document.getElementById("title").value = "";
        document.getElementById("director").value = "";
        document.getElementById("release_year").value = "";
        document.getElementById("rating").value = "";
        retrieveMovies();
        addtoggle2();
      })
      .catch(() => alert("Error adding movie."));
    }

    function retrieveMovies() {
      const search = document.getElementById("search").value;
      fetch(`http://127.0.0.1:3000/movies?page=${currentPage}&limit=10&sortBy=${sortBy}&order=${order}&search=${encodeURIComponent(search)}`)
        .then(res => res.json())
        .then(movies => {
          const tbody = document.querySelector("#moviesTable tbody");
          tbody.innerHTML = "";

          movies.forEach(movie => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${movie.movieID}</td>
              <td>${movie.title}</td>
              <td>${movie.director}</td>
              <td>${movie.release_year}</td>
              <td>${movie.rating}</td>
              <td></td>
            `;

            const actionsCell = row.querySelector("td:last-child");

            const editBtn = document.createElement("button");
            editBtn.textContent = "Edit";
            editBtn.className = "editbtn";
            editBtn.onclick = () => {
              document.getElementById("edit_movieID").value = movie.movieID;
              document.getElementById("edit_title").value = movie.title;
              document.getElementById("edit_director").value = movie.director;
              document.getElementById("edit_release_year").value = movie.release_year;
              document.getElementById("edit_rating").value = movie.rating;
              toggleEditPopup();
            };

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className = "deletebtn";
            deleteBtn.onclick = () => {
              if (confirm(`Are you sure you want to delete movie ID ${movie.movieID}?`)) {
                fetch(`http://127.0.0.1:3000/deleteMovies/${movie.movieID}`, { method: 'DELETE' })
                  .then(() => {
                    alert("Movie deleted successfully!");
                    retrieveMovies();
                  })
                  .catch(() => alert("Failed to delete movie."));
              }
            };

            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(deleteBtn);
            tbody.appendChild(row);
          });

          document.getElementById("pageIndicator").innerText = `Page ${currentPage}`;
        });
    }

    function changePage(direction) {
      if (direction === 'next') currentPage++;
      else if (direction === 'prev' && currentPage > 1) currentPage--;
      retrieveMovies();
    }

    function sortTable(column) {
      if (sortBy === column) {
        order = order === 'asc' ? 'desc' : 'asc';
      } else {
        sortBy = column;
        order = 'asc';
      }
      retrieveMovies();
    }

    function retrieveMovieByID() {
      const movieID = document.getElementById("retrieve_movieID").value;
      fetch(`http://127.0.0.1:3000/movies/${movieID}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("retrieve_title").value = data.title;
          document.getElementById("retrieve_director").value = data.director;
          document.getElementById("retrieve_release_year").value = data.release_year;
          document.getElementById("retrieve_rating").value = data.rating;
        })
        .catch(() => alert("Movie not found."));
    }

    function updateMovie() {
      const movieID = document.getElementById("edit_movieID").value;
      const title = document.getElementById("edit_title").value;
      const director = document.getElementById("edit_director").value;
      const release_year = parseInt(document.getElementById("edit_release_year").value);
      const rating = parseFloat(document.getElementById("edit_rating").value);

      if (!title || !director || isNaN(release_year) || isNaN(rating)) {
        return alert("Please fill all fields correctly.");
      }

      fetch(`http://127.0.0.1:3000/updateMovies/${movieID}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, director, release_year, rating })
      })
      .then(res => res.json())
      .then(() => {
        alert("Movie updated!");
        retrieveMovies();
        toggleEditPopup();
      })
      .catch(() => alert("Error updating movie."));
    }

    window.onload = () => {
      retrieveMovies();
      document.getElementById("search").addEventListener("input", () => {
        currentPage = 1;
        retrieveMovies();
      });
    };
  </script>
</body>
</html>
